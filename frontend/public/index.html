<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Upload & Export Excel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* Estilo para manter o cabeçalho e o rodapé fixos enquanto o corpo rola */
    .table-container {
      max-height: 60vh;
      overflow-y: auto;
      position: relative;
    }
    thead th {
      position: sticky;
      top: 0;
      z-index: 20;
      background-color: #e5e7eb;
    }
    thead tr:nth-child(2) th {
      top: 45px;
      z-index: 20;
    }
    tfoot {
        position: sticky;
        bottom: 0;
        z-index: 20;
        background-color: #f3f4f6;
        border-top: 2px solid #d1d5db;
    }
    .progress-bar-fill {
        transition: width 0.3s ease;
    }
  </style>
</head>

<body class="bg-gray-100 h-screen w-screen flex flex-col">

  <header class="bg-blue-700 text-white p-4 shadow-md flex justify-between items-center">
    <h1 class="text-2xl font-bold">Processador de Excel</h1>
  </header>

  <main class="flex-1 overflow-auto p-6">
    <div class="w-full bg-white shadow rounded-xl p-6">

      <div class="mb-6">
        <label class="block text-gray-800 mb-2 font-semibold">Selecione um arquivo .xlsx</label>
        <div class="flex gap-4">
            <input 
              id="fileInput" 
              type="file" 
              accept=".xlsx"
              class="flex-1 border border-gray-300 p-3 rounded-lg cursor-pointer hover:border-gray-400"
            >
            <button 
                id="btnUpload"
                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold shadow-md">
                Enviar
            </button>
        </div>

        <div id="progressContainer" class="mt-4 hidden">
            <div class="flex justify-between mb-1">
                <span id="progressStatus" class="text-sm font-medium text-blue-700">Enviando...</span>
                <span id="progressPercent" class="text-sm font-medium text-blue-700">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner overflow-hidden">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-full progress-bar-fill" style="width: 0%"></div>
            </div>
        </div>

      </div>

      <div id="result" class="mt-8 hidden">
        
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-2xl font-semibold text-gray-800">Resultado da Análise</h2>
            
            <button 
                id="btnExport" 
                onclick="exportToExcel()"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded inline-flex items-center transition-colors shadow-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Baixar Excel (.xlsx)
            </button>
        </div>

        <div class="border border-gray-300 rounded-lg shadow-sm bg-white">
            <div class="table-container rounded-t-lg">
                <table class="min-w-full text-sm border-collapse" id="dataTable">
                    <thead id="tableHead" class="shadow-sm"></thead>
                    <tbody id="tableBody"></tbody>
                    <tfoot id="tableFooter" class="text-gray-700 font-semibold bg-gray-100">
                        <tr>
                            <td colspan="100%" class="px-4 py-3 text-right">
                                <div class="flex justify-end gap-6">
                                    <span>Total de Linhas: <span id="statTotalLines" class="text-blue-600">0</span></span>
                                    <span>Linhas com erro: <span id="statNotFound" class="text-red-600">0</span></span>
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="mt-8">
            <details>
                <summary class="cursor-pointer text-gray-500 hover:text-gray-700">Ver JSON Bruto</summary>
                <pre id="jsonOutput" class="mt-2 bg-gray-900 text-green-300 p-4 rounded-lg text-xs overflow-auto max-h-40"></pre>
            </details>
        </div>

      </div>
    </div>
  </main>

 <script>
    // Variável global para armazenar os dados processados para exportação
    let globalData = [];
    let globalFileName = "resultado";

    document.getElementById("btnUpload").onclick = () => {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];
        const btn = document.getElementById("btnUpload");

        // Elementos UI
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const progressPercent = document.getElementById("progressPercent");
        const progressStatus = document.getElementById("progressStatus");

        if (!file) {
            alert("Selecione um arquivo Excel primeiro!");
            return;
        }

        // Atualiza nome base do arquivo para exportação
        globalFileName = file.name.split('.')[0] + "_processado";

        const formData = new FormData();
        formData.append("file", file);

        // Reset UI
        btn.innerText = "Enviando...";
        btn.disabled = true;
        btn.classList.add("opacity-50");
        document.getElementById("result").classList.add("hidden"); 
        
        progressContainer.classList.remove("hidden");
        progressBar.style.width = "0%";
        progressPercent.innerText = "0%";
        progressStatus.innerText = "Carregando arquivo...";

        const xhr = new XMLHttpRequest();

        // 1. Progresso
        xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
                const percentComplete = Math.round((event.loaded / event.total) * 100);
                progressBar.style.width = percentComplete + "%";
                progressPercent.innerText = percentComplete + "%";
                if (percentComplete === 100) {
                    progressStatus.innerText = "Processando dados no servidor...";
                    progressBar.classList.remove("bg-blue-600");
                    progressBar.classList.add("bg-green-500", "animate-pulse");
                }
            }
        };

        // 2. Load
        xhr.onload = () => {
            resetUI();
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const resp = JSON.parse(xhr.responseText);
                    handleSuccess(resp);
                } catch (e) {
                    alert("Erro ao ler resposta: " + e.message);
                }
            } else {
                try {
                    const errorResp = JSON.parse(xhr.responseText);
                    alert("Erro: " + (errorResp.error || "Erro desconhecido"));
                } catch (e) {
                    alert("Erro " + xhr.status + " no servidor.");
                }
            }
        };

        // 3. Error
        xhr.onerror = () => {
            resetUI();
            alert("Erro de conexão.");
        };

        xhr.open("POST", "/upload", true);
        xhr.send(formData);

        function resetUI() {
            btn.innerText = "Enviar";
            btn.disabled = false;
            btn.classList.remove("opacity-50");
            setTimeout(() => {
                 progressContainer.classList.add("hidden");
                 progressBar.classList.add("bg-blue-600");
                 progressBar.classList.remove("bg-green-500", "animate-pulse");
            }, 1000);
        }

        function handleSuccess(resp) {
            if (!resp.data || !Array.isArray(resp.data)) {
                alert("Dados inválidos.");
                return;
            }

            // Salva dados na variável global para exportação
            globalData = resp.data;

            document.getElementById("result").classList.remove("hidden");
            document.getElementById("jsonOutput").innerText = JSON.stringify(resp, null, 2);

            const data = resp.data;
            const columns = data.length > 0 ? Object.keys(data[0]) : [];
            
            // Contagem por LINHA
            const totalLines = data.length;
            let notFoundRowsCount = 0;

            data.forEach(row => {
                const hasErrorInRow = columns.some(col => String(row[col]).trim() === "Não encontrado");
                if (hasErrorInRow) notFoundRowsCount++;
            });

            document.getElementById("statTotalLines").innerText = totalLines;
            document.getElementById("statNotFound").innerText = notFoundRowsCount;

            renderTable(columns, data);
        }

        function renderTable(columns, data) {
            const tableHead = document.getElementById("tableHead");
            const tableBody = document.getElementById("tableBody");
            
            tableHead.innerHTML = "";
            tableBody.innerHTML = "";

            if (columns.length > 0) {
                const trTitle = document.createElement("tr");
                const trFilter = document.createElement("tr");

                columns.forEach((col, index) => {
                    const th = document.createElement("th");
                    th.className = "border-b border-r px-4 py-2 text-left font-bold text-gray-700 bg-gray-200 whitespace-nowrap";
                    th.textContent = col;
                    trTitle.appendChild(th);

                    const thFilter = document.createElement("th");
                    thFilter.className = "border-b border-r p-1 bg-gray-100";
                    const input = document.createElement("input");
                    input.type = "text";
                    input.placeholder = `Filtrar...`;
                    input.className = "w-full text-xs p-1 border rounded focus:outline-none focus:border-blue-500 font-normal";
                    input.onkeyup = () => filterTable();
                    thFilter.appendChild(input);
                    trFilter.appendChild(thFilter);
                });
                tableHead.appendChild(trTitle);
                tableHead.appendChild(trFilter);
            }

            data.forEach(row => { 
                const tr = document.createElement("tr");
                tr.className = "odd:bg-white even:bg-slate-50 hover:bg-blue-50 transition-colors";

                columns.forEach(col => {
                    const td = document.createElement("td");
                    td.className = "border-b border-r px-4 py-2 whitespace-nowrap";
                    const cellValue = row[col] !== undefined ? row[col] : '';
                    td.textContent = cellValue;

                    if (String(cellValue).trim() === "Não encontrado") {
                        td.classList.add("text-red-600", "font-bold", "bg-red-50");
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
    };

    // ==========================================
    // FUNÇÃO DE EXPORTAÇÃO (EXCEL)
    // ==========================================
    function exportToExcel() {
        if (!globalData || globalData.length === 0) {
            alert("Não há dados para exportar.");
            return;
        }

        // 1. Cria uma Worksheet (planilha) a partir do JSON
        const worksheet = XLSX.utils.json_to_sheet(globalData);

        // 2. Cria um Workbook (arquivo Excel)
        const workbook = XLSX.utils.book_new();

        // 3. Adiciona a planilha ao arquivo
        XLSX.utils.book_append_sheet(workbook, worksheet, "Dados Processados");

        // 4. Gera e baixa o arquivo
        XLSX.writeFile(workbook, `${globalFileName}.xlsx`);
    }

    // Função de Filtro Dinâmico
    window.filterTable = function() {
        const table = document.getElementById("dataTable");
        const tr = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
        const inputs = table.getElementsByTagName("thead")[0].getElementsByTagName("input");
        
        const filters = [];
        for (let i = 0; i < inputs.length; i++) filters.push(inputs[i].value.toUpperCase());

        for (let i = 0; i < tr.length; i++) {
            let showRow = true;
            const tds = tr[i].getElementsByTagName("td");
            for (let j = 0; j < filters.length; j++) {
                if (filters[j] && tds[j]) {
                    const txtValue = tds[j].textContent || tds[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filters[j]) === -1) {
                        showRow = false; break;
                    }
                }
            }
            tr[i].style.display = showRow ? "" : "none";
        }
    }
</script>

</body>
</html>