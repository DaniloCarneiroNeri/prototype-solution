<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoProcessor - Correção Visual</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* Ajuste para o container do mapa dentro do Modal */
        #mapContainer {
            width: 100%;
            height: 400px;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
        }
        /* Cursor de mira no mapa */
        .cursor-crosshair {
            cursor: crosshair !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div class="container mx-auto p-6">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-blue-700">GeoProcessor <span class="text-sm font-normal text-gray-500">v2.0 (Visual)</span></h1>
                <p class="text-gray-600">Importe, processe e corrija visualmente as rotas.</p>
            </div>
            <div class="flex gap-2">
                <button id="btnExportExcel" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 hidden">Excel</button>
                <button id="btnExportCircuit" class="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 hidden">Circuit</button>
            </div>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex items-center gap-4">
                <input type="file" id="fileInput" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <button id="btnUpload" class="bg-blue-600 text-white px-6 py-2 rounded shadow hover:bg-blue-700 transition">Processar</button>
            </div>
            <div id="progressContainer" class="w-full bg-gray-200 rounded-full h-2.5 mt-4 hidden">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="statusText" class="text-sm text-gray-500 mt-2"></p>
        </div>

        <div id="resultArea" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700 uppercase font-bold">
                        <tr>
                            <th class="px-4 py-3">Ação</th>
                            <th class="px-4 py-3">Endereço Original</th>
                            <th class="px-4 py-3">Lat / Lng</th>
                            <th class="px-4 py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="mapModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 p-6 relative">
            
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Correção Manual de Localização</h3>
                <button onclick="closeMapModal()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>

            <p class="text-sm text-gray-600 mb-2">Clique no mapa onde é o local exato deste endereço:</p>
            <p id="modalAddressLabel" class="font-bold text-blue-800 mb-4 bg-blue-50 p-2 rounded"></p>

            <div id="mapContainer"></div>

            <div class="mt-4 flex justify-between items-center">
                <div class="text-sm">
                    Selecionado: <span id="selectedCoords" class="font-mono text-gray-700">Nenhum</span>
                </div>
                <button id="btnConfirmLocation" class="bg-blue-600 text-white px-6 py-2 rounded shadow hover:bg-blue-700 disabled:opacity-50" disabled>
                    Confirmar Correção
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as Exports from './js/exports.js'; // Importa seu arquivo original

        // --- CONFIGURAÇÃO ---
        // !!! SUBSTITUA PELA SUA CHAVE REAL AQUI PARA O TESTE DO HTML !!!
        const HERE_API_KEY = "BJYVOFTZ4a9ORwZj8G3MB4e_jG2v5WJECQmIeHUxXvw"; 
        
        // Estado Global
        let globalData = [];
        let globalFileName = "exportacao";
        let currentEditingIndex = null;
        
        // Variáveis do Mapa
        let map, behavior, ui, marker;
        let platform;

        document.addEventListener("DOMContentLoaded", () => {
            initMapPlatform(); // Prepara o mapa
        });

        // ============================================================
        // 1. LÓGICA DE UPLOAD (Igual ao seu original, adaptado)
        // ============================================================
        document.getElementById("btnUpload").onclick = () => {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return alert("Selecione um arquivo!");

            globalFileName = file.name.split('.')[0];
            
            // UI Update
            document.getElementById("progressContainer").classList.remove("hidden");
            const pBar = document.getElementById("progressBar");
            
            const formData = new FormData();
            formData.append("file", file);

            const xhr = new XMLHttpRequest();
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const pct = (e.loaded / e.total) * 100;
                    pBar.style.width = pct + "%";
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const resp = JSON.parse(xhr.responseText);
                    handleSuccess(resp.data);
                } else {
                    alert("Erro no servidor");
                }
            };

            xhr.open("POST", "/upload", true);
            xhr.send(formData);
        };

        // ============================================================
        // 2. RENDERIZAÇÃO DA TABELA (COM O NOVO BOTÃO)
        // ============================================================
        function handleSuccess(data) {
            globalData = data;
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            
            document.getElementById("resultArea").classList.remove("hidden");
            document.getElementById("btnExportExcel").classList.remove("hidden");
            document.getElementById("btnExportCircuit").classList.remove("hidden");

            globalData.forEach((row, index) => {
                const tr = document.createElement("tr");
                tr.className = "border-b hover:bg-gray-50";

                // Verifica status
                const lat = row["Geo_Latitude"];
                const isFound = lat && lat !== "Não encontrado";
                const isPartial = row["Partial_Match"] === true;
                
                // Define cor do status
                let statusBadge = "";
                let needsFix = false;

                if (!isFound) {
                    statusBadge = `<span class="bg-red-100 text-red-800 text-xs font-semibold px-2.5 py-0.5 rounded">Não Encontrado</span>`;
                    needsFix = true;
                } else if (isPartial) {
                    statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded">Parcial</span>`;
                    needsFix = true;
                } else {
                    statusBadge = `<span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded">OK</span>`;
                }

                // Coluna de Ação (A MÁGICA ACONTECE AQUI)
                // Se precisar de correção, mostra a setinha ">"
                const actionBtn = needsFix 
                    ? `<button onclick="window.openEditor(${index})" class="bg-blue-100 hover:bg-blue-600 hover:text-white text-blue-600 rounded-full w-8 h-8 flex items-center justify-center transition" title="Corrigir no Mapa">
                         ➤
                       </button>`
                    : `<span class="text-green-500">✓</span>`;

                tr.innerHTML = `
                    <td class="px-4 py-3">${actionBtn}</td>
                    <td class="px-4 py-3 truncate max-w-xs" title="${row['Destination Address']}">${row['Destination Address'] || '-'}</td>
                    <td class="px-4 py-3 font-mono text-xs" id="coord-${index}">
                        ${isFound ? `${row['Geo_Latitude']}, ${row['Geo_Longitude']}` : '---'}
                    </td>
                    <td class="px-4 py-3">${statusBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============================================================
        // 3. LÓGICA DO MAPA HERE
        // ============================================================
        function initMapPlatform() {
            platform = new H.service.Platform({
                'apikey': HERE_API_KEY
            });
        }

        // Função global para ser chamada pelo HTML onclick
        window.openEditor = function(index) {
            currentEditingIndex = index;
            const row = globalData[index];
            const modal = document.getElementById("mapModal");
            
            // 1. Abre Modal
            modal.classList.remove("hidden");
            document.getElementById("modalAddressLabel").textContent = row['Destination Address'] + " (" + row['Bairro'] + ")";
            document.getElementById("btnConfirmLocation").disabled = true;
            document.getElementById("selectedCoords").textContent = "Clique no mapa...";

            // 2. Inicializa o Mapa (apenas na primeira vez ou resize)
            if (!map) {
                const defaultLayers = platform.createDefaultLayers();
                map = new H.Map(
                    document.getElementById('mapContainer'),
                    defaultLayers.vector.normal.map,
                    { zoom: 14, center: { lat: -16.6868, lng: -49.2647 } } // Goiânia Default
                );
                
                // Eventos e UI
                behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
                ui = H.ui.UI.createDefault(map, defaultLayers);

                // LISTENER DE CLIQUE NO MAPA
                map.addEventListener('tap', function(evt) {
                    // Converte pixel clicado para lat/lng
                    var coord = map.screenToGeo(evt.currentPointer.viewportX, evt.currentPointer.viewportY);
                    
                    // Adiciona/Move Marcador
                    if (marker) map.removeObject(marker);
                    marker = new H.map.Marker(coord);
                    map.addObject(marker);

                    // Atualiza UI do Modal
                    document.getElementById("selectedCoords").textContent = `${coord.lat.toFixed(5)}, ${coord.lng.toFixed(5)}`;
                    document.getElementById("btnConfirmLocation").disabled = false;
                    
                    // Salva temporariamente no botão
                    document.getElementById("btnConfirmLocation").dataset.lat = coord.lat;
                    document.getElementById("btnConfirmLocation").dataset.lng = coord.lng;
                });
            }

            // 3. Centraliza o mapa
            // Se já tiver uma lat/lng (mesmo parcial), tenta focar lá. Se não, foca em Goiânia.
            setTimeout(() => {
                map.getViewPort().resize(); // BUGFIX: Essencial para mapas em modais
                
                let startLat = row["Geo_Latitude"];
                let startLng = row["Geo_Longitude"];
                
                if (startLat && startLat !== "Não encontrado") {
                    map.setCenter({lat: startLat, lng: startLng});
                    map.setZoom(16);
                    
                    // Mostra onde o sistema "achou" que era
                    if (marker) map.removeObject(marker);
                    marker = new H.map.Marker({lat: startLat, lng: startLng});
                    map.addObject(marker);
                } else {
                    map.setCenter({ lat: -16.6868, lng: -49.2647 });
                    map.setZoom(13);
                    if (marker) map.removeObject(marker);
                }
            }, 100);
        };

        // Botão Fechar Modal
        window.closeMapModal = function() {
            document.getElementById("mapModal").classList.add("hidden");
            currentEditingIndex = null;
        };

        // Botão Confirmar
        document.getElementById("btnConfirmLocation").onclick = function() {
            if (currentEditingIndex === null) return;

            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);

            // 1. ATUALIZA OS DADOS NA MEMÓRIA
            globalData[currentEditingIndex]["Geo_Latitude"] = lat;
            globalData[currentEditingIndex]["Geo_Longitude"] = lng;
            globalData[currentEditingIndex]["Status_Log"] = "MANUAL_FIX";
            globalData[currentEditingIndex]["Partial_Match"] = false; // Agora é certeza

            // 2. ATUALIZA A TABELA VISUALMENTE
            const td = document.getElementById(`coord-${currentEditingIndex}`);
            if (td) {
                td.innerHTML = `<span class="text-blue-600 font-bold">${lat.toFixed(5)}, ${lng.toFixed(5)}</span>`;
                td.parentElement.querySelector("td:last-child").innerHTML = `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">Corrigido</span>`;
                // Troca o botão de ação por um Check verde
                td.parentElement.querySelector("td:first-child").innerHTML = `<span class="text-blue-500 font-bold">✓</span>`;
            }

            closeMapModal();
        };

        // ============================================================
        // 4. EXPORTAÇÃO
        // ============================================================
        document.getElementById("btnExportExcel").onclick = () => {
            Exports.exportToExcel(globalData, globalFileName);
        };
        
        document.getElementById("btnExportCircuit").onclick = () => {
            Exports.exportToCircuit(globalData, globalFileName);
        };

    </script>
</body>
</html>